
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title></title>
  <link href="reveal/css/reveal.min.css" media="screen" rel="stylesheet" />
  <link href="reveal/css/theme/beige.css" media="screen" rel="stylesheet" />
  <link href="reveal/lib/css/zenburn.css" media="screen" rel="stylesheet" />
  <link href="app/app.css" media="screen" rel="stylesheet" />
</head>
<body>
<div id="md2reveal" class="reveal">
  <div class="slides">
<section>
      <section>
<h1><img src="images/perl-entrance_t.png" alt="Perl入学式" /></h1>

</section>

</section>
<section>
      <section>
<h1>Perl入学式 #10</h1>

<p><a href="http://www.perl-entrance.org">http://www.perl-entrance.org</a></p>

<ul>
<li>日時
<ul>
<li>2012年11月25日（日） 14:00 - 17:00</li>
</ul></li>
<li>会場
<ul>
<li>Joe'sクラウドコンピューティング</li>
<li><a href="http://www.joeswebhosting.net">http://www.joeswebhosting.net</a></li>
</ul></li>
</ul>

</section>

</section>
<section>
      <section>
<h1>Perl入学式について</h1>

<ul>
<li>Perl入学式(<a href="http://www.perl-entrance.org">http://www.perl-entrance.org</a>)は, プログラミング未経験者からPerl初心者を対象としたワークショップです</li>
<li>公式Twitter
<ul>
<li><a href="http://twitter.com/perl_entrance">@Perl_Entrance</a></li>
</ul></li>
<li>公式ハッシュタグ
<ul>
<li>#Perl入学式</li>
</ul></li>
<li>公式Facebookページ
<ul>
<li><a href="https://www.facebook.com/PerlEntrance">https://www.facebook.com/PerlEntrance</a></li>
</ul></li>
</ul>

</section>

</section>
<section>
      <section>
<h1>会場について</h1>

<ul>
<li>今回のPerl入学式は「Joe'sオープンソースJelly」の一環ということで、株式会社Joe'sクラウドコンピューティング（<a href="http://www.joeswebhosting.net">http://www.joeswebhosting.net</a>）様より特別に会場をお借りしています</li>
<li>この場をお借りしてお礼申し上げます</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>ロゴについて</h1>

<p><img src="images/perl-entrance_t_300.png" alt="Perl入学式" /></p>

<ul>
<li>横山陽平さん(<a href="http://yokoyamayohei.com/">http://yokoyamayohei.com/</a>)にデザインしていただきました</li>
<li>この場をお借りしてお礼申し上げます</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>IT勉強会スタンプラリー</h1>

<p><img src="images/it-stamp.png" alt="IT勉強会スタンプラリー" /></p>

<ul>
<li>Perl入学式は, IT勉強会スタンプラリー(<a href="http://it-stamp.jp/">http://it-stamp.jp/</a>)に参加しています</li>
<li>今回のPerl入学式は, スタンプラリーの対象となる勉強会です</li>
<li>台紙は勉強会終了後にお渡しします</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>喋ってる人</h1>

<ul>
<li>名前 ： 若林 信敬</li>
<li>Twitter ： <a href="http://twitter.com/nqounet">@nqounet</a></li>
<li>Facebook ： <a href="https://www.facebook.com/nobutaka.wakabayashi">nobutaka.wakabayashi</a></li>
<li>仕事 ： フリーエンジニア（IT系）</li>
<li>屋号 ： <a href="http://www.nishimiyahara.net">IT Office 西宮原</a></li>
</ul>

</section>

</section>
<section>
      <section>
<h1>#10の目標</h1>

<ul>
<li>Perl入学式の最終目標である簡易掲示板を、復習しながら実際に作成していきます。</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>本日の内容</h1>

</section>

      <section>
<h2>本日の内容（その１）</h2>

<ul>
<li>とりあえずページを表示してみよう（helloworld）</li>
<li>フォームを作ってみよう(form)</li>
<li>フォームから投稿された文字列をそのまま表示してみよう（get）</li>
<li>長い文が投稿されてもちゃんと表示できるようにしてみよう（post）</li>
</ul>

</section>

      <section>
<h2>本日の内容（その２）</h2>

<ul>
<li>テンプレートの重複部分をまとめてみよう（include）</li>
<li>投稿された記事を蓄えてみよう（file）</li>
<li>日本語（マルチバイト文字）をちゃんと保存してみよう（encode_utf8）</li>
<li>蓄えられた記事を表示してみよう（decode_utf8）</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>準備</h1>

<ul>
<li>Perl</li>
<li>Mojolicious</li>
<li>Git</li>
</ul>

</section>

      <section>
<h2>Perl</h2>

<ul>
<li><code>Perl</code>の環境を構築しておきましょう。</li>
</ul>

<h4><a href="http://www.perl-entrance.org/p/modernperl20128.html">Perl入学式: ModernなPerlの開発環境の構築方法（2012年8月版）</a></h4>

</section>

      <section code>
<h2>Mojolicious</h2>

<ul>
<li><code>Mojolicious</code>をインストールしておきましょう。</li>
</ul>

<!-- code -->

<pre><code>$ cpanm Mojolicious
</code></pre>

</section>

</section>
<section>
      <section>
<h1>Hello World</h1>

</section>

      <section code code>
<h2>とりあえずページを表示してみよう</h2>

<ul>
<li>Mojoliciousの機能を使って雛形を作成します。</li>
</ul>

<!-- code -->

<pre><code>$ mojo generate lite_app
</code></pre>

<ul>
<li>以下のような表示が出ていれば、ちゃんと実行できています。</li>
</ul>

<!-- code -->

<pre><code>[chmod] myapp.pl 744
</code></pre>

</section>

      <section code code>
<h2>Hello World</h2>

<ul>
<li><code>myapp.pl</code>というファイル名プログラムが作成されているので、そのプログラムを実行します。</li>
</ul>

<!-- code -->

<pre><code>$ morbo myapp.pl
</code></pre>

<ul>
<li>以下のような表示が出ていれば、ちゃんと実行できています。</li>
</ul>

<!-- code -->

<pre><code>Server available at http://127.0.0.1:3000.
</code></pre>

</section>

      <section code>
<h2>Hello World</h2>

<ul>
<li>ブラウザを開いて、<code>http://localhost:3000</code>にアクセスしてみてください。</li>
<li>以下のような文字が表示されればOKです。</li>
</ul>

<!-- code -->

<pre><code>Welcome to the Mojolicious real-time web framework!
</code></pre>

</section>

</section>
<section>
      <section>
<h1>Form</h1>

</section>

      <section>
<h2>フォームを作ってみよう</h2>

<ul>
<li>まずはフォームを作ってみます。</li>
</ul>

</section>

      <section code>
<h2>Form</h2>

<ul>
<li>日本語を都合よく扱うための処理を書きます。</li>
</ul>

<!-- code -->

<pre><code>#!/usr/bin/env perl
use utf8; # &lt;この行を挿入
use Mojolicious::Lite;
</code></pre>

</section>

      <section data-state="appendix" code code>
<h2>use utf8;</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>use utf8;</code>した状態のPerlは、日本語などのマルチバイト文字でも、文字として正しく扱うことができます。</li>
<li>ターミナルで試してみましょう</li>
</ul>

<!-- code -->

<pre><code># use utf8;していない状態
$ perl -e 'print length "abcあいう";'
</code></pre>

<!-- code -->

<pre><code># use utf8;した状態
$ perl -Mutf8 -e 'print length "abcあいう";'
</code></pre>

</section>

      <section code>
<h2>Form</h2>

<ul>
<li>その後ろ2行ほどを削除します。</li>
</ul>

<!-- code -->

<pre><code># Documentation browser under "/perldoc" # &lt;この行を削除
plugin 'PODRenderer'; # &lt;この行を削除
</code></pre>

</section>

      <section data-state="appendix">
<h2>PODRenderer</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>PODRenderer</code>は<code>Mojolicious</code>のプラグインで、<code>perldoc</code>を綺麗に見るためのプラグインです。</li>
<li>削除する前に、<code>http://localhost:3000/perldoc</code>にアクセスして確認してみてください。</li>
</ul>

</section>

      <section code>
<h2>Form</h2>

<ul>
<li>もともと表示されている文字列を削除します。</li>
</ul>

<!-- code -->

<pre><code>Welcome to the Mojolicious real-time web framework! # &lt;削除
</code></pre>

</section>

      <section code>
<h2>Form</h2>

<ul>
<li>削除したところに、フォームを出力するコードを書きます。</li>
</ul>

<!-- code -->

<pre><code>%= form_for '/' =&gt; begin
  %= text_field 'body'
  %= submit_button '投稿する'
% end
</code></pre>

</section>

      <section data-state="appendix">
<h2>helper</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>form_for</code>、<code>text_field</code>、<code>submit_button</code>などは、<code>Mojolicious</code>の<code>helper</code>という機能で定義されたPerlの関数（サブルーチン）です。</li>
<li><code>helper</code>については、次回詳しく説明する予定です。</li>
</ul>

<h4><a href="https://github.com/yuki-kimoto/mojolicious-guides-japanese/wiki/Mojolicious%3A%3APlugin%3A%3ATagHelpers">Mojolicious::Plugin::TagHelpers · yuki-kimoto/mojolicious-guides-japanese Wiki</a></h4>

</section>

      <section>
<h2>Form</h2>

<ul>
<li><p>ここまで出来たら、ブラウザをリロードしてみてください。</p></li>
<li><p>こんな感じでフォームが表示されていればOKです。</p></li>
</ul>

<p><img src="images/pe10-01.png" alt="image" /></p>

<ul>
<li><p>閉じてしまった人は、<code>http://localhost:3000</code>にアクセスしてください。</p></li>
<li><p>この後も、入力が終わったら動作を確認するので、ブラウザはそのまま開いておいてください。</p></li>
</ul>

</section>

</section>
<section>
      <section>
<h1>Get</h1>

</section>

      <section>
<h2>フォームから投稿された文字列をそのまま表示してみよう</h2>

<ul>
<li>先ほどのフォームから投稿しても、画面上は何も変わりません。</li>
<li>画面に、フォームから投稿された文字列を、そのまま表示するようにしてみましょう。</li>
</ul>

</section>

      <section code>
<h2>Get</h2>

<ul>
<li><p>まずはテンプレートを変更します。</p></li>
<li><p>19行目あたりに以下のように追加します。</p></li>
</ul>

<!-- code -->

<pre><code>  %= submit_button '投稿する'
% end
&lt;p&gt;&lt;%= $body %&gt;&lt;/p&gt; &lt;この行を挿入
</code></pre>

<ul>
<li><p><code>&lt;%= $body %&gt;</code>は、テンプレートの中でPerlの変数などを表示するときに使用します。</p></li>
<li><p>今の場合、Perlで書いてある<code>$body</code>という変数の値を表示する、という意味になります。</p></li>
</ul>

</section>

      <section data-state="appendix">
<h2>.ep</h2>

<!-- data-state="appendix" -->

<ul>
<li>テンプレート（例えば<code>index.html.ep</code>）の最後には<code>.ep</code>という拡張子がついています。</li>
<li>この拡張子は<code>Embedded Perl</code>の頭文字をとったものです。</li>
<li>これは<code>Mojolicious</code>が標準で使えるテンプレートのシステムを示しています。</li>
</ul>

</section>

      <section data-state="appendix" code>
<h2>template</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>Mojolicious</code>のテンプレートでPerlのコードを実行させる書き方としては、<code>タグ</code>と<code>行</code>の二種類があります。</li>
</ul>

<!-- code -->

<pre><code># タグ
&lt;% Perlのコード %&gt;
&lt;%= Perlのコード %&gt;
&lt;%== Perlのコード %&gt;

# 行
% Perlのコード
%= Perlのコード
%== Perlのコード
</code></pre>

<h4><a href="https://github.com/yuki-kimoto/mojolicious-guides-japanese/wiki/Mojolicious%3A%3AGuides%3A%3ARendering">Mojolicious::Guides::Rendering · yuki-kimoto/mojolicious-guides-japanese Wiki</a></h4>

</section>

      <section code>
<h2>Get</h2>

<ul>
<li>次に、formの情報を取得します。</li>
</ul>

<!-- code -->

<pre><code>get '/' =&gt; sub {
  my $self = shift;
  $self-&gt;render('index');
  my $body = $self-&gt;param('body'); # &lt; この行を挿入
</code></pre>

<ul>
<li><code>$self-&gt;param('body')</code>は、フォームから投稿した<code>body</code>という名前がついている値を取得します。</li>
</ul>

</section>

      <section code>
<h2>Get</h2>

<ul>
<li>続いて、先ほど取得した情報を、テンプレートで使えるようにします。</li>
</ul>

<!-- code -->

<pre><code>  my $body = $self-&gt;param('body');
  $self-&gt;stash(body =&gt; $body); # &lt; この行を挿入
</code></pre>

<ul>
<li><p><code>$self-&gt;stash()</code>に、値を渡すと、テンプレートでも使えるようになります。</p></li>
<li><p>今の場合は、<code>body</code>に、変数<code>$body</code>を渡したので、テンプレートでは<code>$body</code>として使えるようになります。</p></li>
</ul>

</section>

      <section>
<h2>Get</h2>

<ul>
<li><p>ここまで出来たら、ブラウザをリロードしてみてください。</p></li>
<li><p>そして、フォームに何か文字を入力して<code>投稿する</code>ボタンをクリックしてみてください。</p></li>
<li><p>フォームに書いた文字がフォームの下に表示されたでしょうか？</p></li>
</ul>

<p><img src="images/pe10-02.png" alt="image" /></p>

</section>

</section>
<section>
      <section>
<h1>Post</h1>

</section>

      <section>
<h2>長い文が投稿されても、ちゃんと表示できるようにしてみよう</h2>

<ul>
<li>画面に投稿した文字列が表示できるようになりましたが、実はとても長い文字列を入力すると、正しく処理できません。</li>
<li>例えば、<code>http://www.yahoo.co.jp/</code>を開いて、ページの情報をコピー＆貼り付けして投稿してみましょう。</li>
<li>アドレスバーには、投稿されたような形跡がありますが、画面上は空のフォームが表示されていると思います。</li>
<li>長い文字列でも正しく動作できるように変更してみましょう。</li>
</ul>

</section>

      <section code>
<h2>Post</h2>

<ul>
<li><p>まずは、現在の<code>get</code>の部分のコードをすべてコピーして貼り付けます。</p></li>
<li><p>そして、bodyに関する部分を削除しておきます。</p></li>
<li><p>最初の<code>get</code>のコードに戻りましたが、気にしないでください。それで正解です。</p></li>
</ul>

<!-- code -->

<pre><code>get '/' =&gt; sub {
  my $self = shift;
  $self-&gt;render('index');
};
</code></pre>

</section>

      <section code>
<h2>Post</h2>

<ul>
<li><p>続いて、postについての処理を書きます。</p></li>
<li><p><code>body</code>の処理が書いてある方を一部変更します。</p></li>
</ul>

<!-- code -->

<pre><code>post '/post' =&gt; sub {
  my $self = shift;
  my $body = $self-&gt;param('body');
  $self-&gt;stash(body =&gt; $body);
  $self-&gt;render('post');
};
</code></pre>

</section>

      <section code>
<h2>Post</h2>

<ul>
<li>続いて、テンプレートも追加します。</li>
<li><code>@@ index.html.ep</code>の部分をすべてコピーして貼り付け、<code>post</code>のページとして一部変更します。</li>
</ul>

<!-- code -->

<pre><code>@@ post.html.ep
% layout 'default';
% title '出力'; # &lt; タイトルを変更
%= form_for '/post' =&gt; method =&gt; 'POST' =&gt; begin # &lt; 投稿先などを変更
  %= text_field 'body'
  %= submit_button '投稿する'
% end
&lt;p&gt;&lt;%= $body %&gt;&lt;/p&gt;
</code></pre>

<ul>
<li><code>form_for</code>に書いてある<code>method =&gt; 'POST'</code>が、肝です。</li>
<li>こうすることで、<code>get</code>ではなく<code>post</code>で送信するようになります。</li>
</ul>

</section>

      <section code>
<h2>Post</h2>

<ul>
<li><code>index</code>の方は、<code>$body</code>を表示しないようにしておきます。</li>
<li><code>form_for</code>も忘れずに変更しておきましょう。</li>
<li>検証しやすいように<code>title</code>を変更しておきましょう。</li>
</ul>

<!-- code -->

<pre><code>@@ index.html.ep
% layout 'default';
% title '入力フォーム';
%= form_for '/post' =&gt; method =&gt; 'POST' =&gt; begin
  %= text_field 'body'
  %= submit_button '投稿する'
% end
</code></pre>

</section>

      <section>
<h2>Post</h2>

<ul>
<li>ここまで出来たら、ブラウザをリロードしてみてください。</li>
<li>そして、フォームに<code>http://www.yahoo.co.jp/</code>のページの内容をコピー＆貼り付けして<code>投稿する</code>ボタンをクリックしてみてください。</li>
<li>getの時には出力できなかった文字列が、フォームの下に表示されたでしょうか？</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>Include</h1>

</section>

      <section>
<h2>テンプレートの重複部分をまとめてみよう</h2>

<ul>
<li>先ほど作成した<code>post</code>のテンプレートは、<code>index</code>をコピー＆貼り付けして作成しましたが、フォームの部分を両方共変更する必要がありました。</li>
<li>このまま使うと、フォームを変更する度に2箇所とも変更する必要があります。</li>
<li>共通しているフォーム部分を一つにまとめてみましょう。</li>
</ul>

</section>

      <section code code>
<h2>Include</h2>

<ul>
<li>まずは共通の部分を作成します。</li>
<li>共通になっているのは以下の部分です。</li>
</ul>

<!-- code -->

<pre><code>%= form_for '/post' =&gt; method =&gt; 'POST' =&gt; begin
  %= text_field 'body'
  %= submit_button '投稿する'
% end
</code></pre>

<ul>
<li>この部分だけを<code>form</code>として定義します。</li>
</ul>

<!-- code -->

<pre><code>@@ form.html.ep
%= form_for '/post' =&gt; method =&gt; 'POST' =&gt; begin
  %= text_field 'body'
  %= submit_button '投稿する'
% end
</code></pre>

</section>

      <section code code>
<h2>Include</h2>

<ul>
<li>新しく作成した<code>form</code>を使うには<code>include</code>という命令を使います。</li>
<li><code>index</code>の部分は以下のようになります。</li>
</ul>

<!-- code -->

<pre><code>@@ index.html.ep
% layout 'default';
% title '入力フォーム';
%= include 'form';
</code></pre>

<ul>
<li><code>post</code>の部分は以下のようになります。</li>
</ul>

<!-- code -->

<pre><code>@@ post.html.ep
% layout 'default';
% title '出力';
%= include 'form';
&lt;p&gt;&lt;%= $body %&gt;&lt;/p&gt;
</code></pre>

</section>

      <section>
<h2>Include</h2>

<ul>
<li>ここまで出来たら、ブラウザをリロードしてみてください。</li>
<li>変化はありませんが、それが正解です。</li>
<li>テンプレートは変えましたが、出力されるHTMLは変えていません。</li>
<li>テンプレートは<code>include</code>を使うことで、共通の部品として利用できます。</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>File</h1>

</section>

      <section>
<h2>投稿された記事を蓄えてみよう</h2>

<ul>
<li>表示することは出来ましたが、このままでは自分自身の投稿（しかも、1回分だけ）しか見ることはできません。</li>
<li>次は、投稿を蓄積するようにしてみましょう。</li>
</ul>

</section>

      <section code>
<h2>File</h2>

<ul>
<li>データを蓄えるために、ファイルを利用します。</li>
<li><code>post</code>の<code>$body</code>を取得したあとに、以下のコードを追加します。</li>
</ul>

<!-- code -->

<pre><code>my $datafile = qq{myapp.dat};
open my $fh, '&gt;&gt;', $datafile or die $!;
print $fh qq{$body\n};
close $fh;
</code></pre>

</section>

      <section data-state="appendix">
<h2>open</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>open</code>の行は、<code>$datafile</code>を追加モード（<code>&gt;&gt;</code>）で開いています。エラーの場合は、ここで異常終了させます。例外を発生させる、とも言います。</li>
<li>ファイルが正しく開けなかった場合には、プログラムの実行を止めておくことが肝心です。</li>
</ul>

<h4><a href="http://perldoc.jp/func/open">open - perldoc.jp</a></h4>

</section>

      <section data-state="appendix">
<h2>print $fh</h2>

<!-- data-state="appendix" -->

<ul>
<li>開いたファイルは、今回の場合は<code>$fh</code>で操作します。</li>
<li>ファイルハンドル、と言います。</li>
<li><code>print</code>のあとにファイルハンドルを書き、その次に出力する文字列を書きます。</li>
</ul>

<h4><a href="http://perldoc.jp/func/print">print - perldoc.jp</a></h4>

</section>

      <section data-state="appendix">
<h2>qq{}</h2>

<!-- data-state="appendix" -->

<ul>
<li><code>qq{}</code>は、<code>"（ダブルクォーテーション）</code>と同じ意味です。</li>
<li>出力する文字列の中に<code>"</code>があるような場合に使うとエスケープが不要になるので、コードが読みやすくなります。</li>
</ul>

<h4><a href="http://perldoc.jp/func/qq">qq - perldoc.jp</a></h4>

</section>

      <section data-state="appendix">
<h2>close $fh</h2>

<!-- data-state="appendix" -->

<ul>
<li>開いたファイルは、ちゃんと閉じましょう。</li>
<li>プログラムが終了すれば自動的に閉じられますが、<code>close</code>をした時点でファイルの取り扱いを終えたことが、コードを読む人にもわかります。</li>
<li>将来の自分自身のために、ちゃんと閉じておきましょう。</li>
</ul>

<h4><a href="http://perldoc.jp/func/close">close - perldoc.jp</a></h4>

</section>

      <section>
<h2>File</h2>

<ul>
<li>ここまで出来たら、ブラウザをリロードしてみてください。</li>
<li>何度か書き込みをしてみて、実際にデータファイルが出来ているか確認してみてください。</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>encode_utf8</h1>

</section>

      <section code>
<h2>日本語（マルチバイト文字）をちゃんと保存してみよう</h2>

<ul>
<li>ファイルにデータが保存されていると思いますが、実は日本語を保存するときにエラーが出ています。</li>
<li><code>morbo myapp.pl</code>したターミナルを確認し、以下のようなエラーが出ているのを確認してください。</li>
</ul>

<!-- code -->

<pre><code>Wide character in print at myapp.pl line 16.
</code></pre>

<ul>
<li>このエラーを修正し、日本語のデータを正しく扱ってみましょう。</li>
</ul>

</section>

      <section code>
<h2>encode_utf8</h2>

<ul>
<li>Perlで文字コードを扱う場合は、<code>Encode</code>というモジュールを使います。</li>
<li>3行目あたりに以下のコードを追加してください。</li>
</ul>

<!-- code -->

<pre><code>use Mojolicious::Lite;
use Encode; # &lt; この行を追加
</code></pre>

</section>

      <section data-state="appendix">
<h2>jcode.pl, Jcode.pm</h2>

<!-- data-state="appendix" -->

<ul>
<li>昔、Perlを使ったことがある方は、<code>jcode.pl</code>や<code>Jcode.pm</code>を知っているかもしれませんが、それらのことは、もう忘れてください。モダンなPerlを理解する上での弊害になります。</li>
<li>モダンなPerl（バージョン5.8.1以降）では、日本語などのマルチバイト文字を扱うスクリプトを書く場合は、文字コードを<code>UTF-8</code>にして、<code>use utf8;</code>を書いておくことが推奨されています。</li>
</ul>

</section>

      <section code>
<h2>encode_utf8</h2>

<ul>
<li><code>use Encode;</code>すると、幾つかの関数が使えるようになります。（エクスポートされる、とも言います）</li>
<li>その中の一つ<code>encode_utf8</code>を使ってエンコードした文字列をファイルに書き込むようにします。</li>
</ul>

<!-- code -->

<pre><code>print $fh qq{$body\n}; # &lt; この行を以下のように変更
    ↓
print $fh encode_utf8(qq{$body\n});
</code></pre>

</section>

      <section>
<h2>encode_utf8</h2>

<ul>
<li>ここまで出来たら、ブラウザをリロードしてみてください。</li>
<li>ひらがなでもカタカナでも漢字でも構いませんので、何度か書き込みをしてみてください。</li>
<li>先ほどのようなエラーがなくなっていると思います。</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>decode_utf8</h1>

</section>

      <section>
<h2>蓄えられた記事を表示してみよう</h2>

<ul>
<li>書いた記事が蓄えられるようになりました。</li>
<li>今度は、その蓄えた記事を表示するようにしてみましょう。</li>
</ul>

</section>

      <section code>
<h2>decode_utf8</h2>

<ul>
<li>トップページのテンプレート（<code>@@ index.html.ep</code>）に、どのように表示するかを考えながら書いて行きましょう。</li>
<li>ここでは段落で書いていきますが、余裕がある人は、番号なしリストなどで書いてみてください。</li>
<li>以下のコードをフォームの下に出力されるように書いてください。</li>
</ul>

<!-- code -->

<pre><code>% for my $entry (@{$entries}) {
  &lt;p&gt;&lt;%= $entry %&gt;&lt;/p&gt;
% }
</code></pre>

</section>

      <section code>
<h2>decode_utf8</h2>

<ul>
<li>ファイルから記事を読み込み、テンプレートに渡します。</li>
<li>ファイルから読み込む時は、Perlで正しく扱うためにデコードしてやる必要があります。</li>
<li>次のスライドにでてくるコードを、トップページの処理に追加します。</li>
</ul>

<!-- code -->

<pre><code>get '/' =&gt; sub {
  my $self = shift;
  # ここに追加します
  $self-&gt;render('index');
};
</code></pre>

</section>

      <section code>
<h2>decode_utf8</h2>

<ul>
<li>まずは、データファイルの設定、そして、ファイルの読み込みです。</li>
</ul>

<!-- code -->

<pre><code>  my $datafile = qq{myapp.dat};
  open my $fh, '&lt;', $datafile or die $!;
  my @entries = &lt;$fh&gt;;
  close $fh;
</code></pre>

</section>

      <section data-state="appendix" code>
<h2><$fh></h2>

<!-- data-state="appendix" -->

<ul>
<li>ファイルから読み込む時は、ファイルハンドルを<code>&lt;$fh&gt;</code>のように<code>&lt;</code>と<code>&gt;</code>でくくります。</li>
<li>配列にファイルハンドルを代入すると、ファイルの1行が1項目となり、すべての行が代入されます。ただし、行末の改行は削除されませんので、注意が必要です。</li>
<li>改行を削除するには<code>chomp</code>を使いますが、<code>chomp</code>は削除した改行の数を返すため使う時は工夫が必要です。</li>
</ul>

<!-- code -->

<pre><code># 失敗例
my @entries = map {chomp} &lt;$fh&gt;;

# こちらは問題なし
my @entries = map {chomp; $_} &lt;$fh&gt;;
</code></pre>

</section>

      <section code>
<h2>decode_utf8</h2>

<ul>
<li>続いて、デコードと、テンプレートへの引渡しです。</li>
</ul>

<!-- code -->

<pre><code>  @entries = map { decode_utf8($_) } @entries;
  $self-&gt;stash(entries =&gt; \@entries);
</code></pre>

</section>

      <section code>
<h2>decode_utf8</h2>

<ul>
<li>トップページの処理は、最終的には以下のようになります。</li>
</ul>

<!-- code -->

<pre><code>get '/' =&gt; sub {
  my $self = shift;
  my $datafile = qq{myapp.dat};
  open my $fh, '&lt;', $datafile or die $!;
  my @entries = &lt;$fh&gt;;
  close $fh;
  @entries = map {decode_utf8($_)} @entries;
  $self-&gt;stash(entries =&gt; \@entries);
  $self-&gt;render('index');
};
</code></pre>

</section>

      <section>
<h2>decode_utf8</h2>

<ul>
<li>ここまで出来たら、ブラウザをリロード、あるいは<code>http://localhost:3000</code>にアクセスしてみてください。</li>
<li>前回から投稿してある文字列が表示されたと思います。</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>続きは次回</h1>

<ul>
<li>今の状態では、投稿したあとの画面では、最後の投稿しか反映されていません。</li>
<li>連続して投稿はできますが、過去の投稿を見るためにはどうすればよいでしょうか？</li>
</ul>

</section>

</section>
<section>
      <section>
<h1>次回予告</h1>

<ul>
<li>投稿した後、記事を表示するページを表示してみよう（redirect_to）</li>
<li>コードの重複部分をまとめてみよう（helper）</li>
<li>URLが投稿されたら自動的にリンクしよう（正規表現）</li>
<li>何も入力しないで投稿したら、リロードしよう</li>
<li>スペース（全角含む）だけの投稿があったらエラーを出そう（バリデーション）</li>
<li>投稿する項目を増やしてみよう</li>
<li>スタイルシートでデザインをつけよう（public）</li>
</ul>

</section>

</section>
<section>
      <section code>
<h1>今回のコード</h1>

<ul>
<li>今回動作させてきた最終的な<code>myapp.pl</code>は、以下のようになります。</li>
</ul>

<!-- code -->

<pre><code>#!/usr/bin/env perl
use utf8;
use Mojolicious::Lite;
use Encode;

get '/' =&gt; sub {
  my $self = shift;
  my $datafile = qq{myapp.dat};
  open my $fh, '&lt;', $datafile or die $!;
  my @entries = &lt;$fh&gt;;
  close $fh;
  @entries = map {decode_utf8($_)} @entries;
  $self-&gt;stash(entries =&gt; \@entries);
  $self-&gt;render('index');
};

post '/post' =&gt; sub {
  my $self = shift;
  my $body = $self-&gt;param('body');
  my $datafile = qq{myapp.dat};
  open my $fh, '&gt;&gt;', $datafile or die $!;
  print $fh encode_utf8(qq{$body\n});
  close $fh;
  $self-&gt;stash(body =&gt; $body);
  $self-&gt;render('post');
};

app-&gt;start;
__DATA__

@@ form.html.ep
%= form_for '/post' =&gt; method =&gt; 'POST' =&gt; begin
  %= text_field 'body'
  %= submit_button '投稿する'
% end

@@ index.html.ep
% layout 'default';
% title '入力フォーム';
%= include 'form';
% for my $entry (@{$entries}) {
  &lt;p&gt;&lt;%= $entry %&gt;&lt;/p&gt;
% }

@@ post.html.ep
% layout 'default';
% title '出力';
%= include 'form';
&lt;p&gt;&lt;%= $body %&gt;&lt;/p&gt;

@@ layouts/default.html.ep
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;&lt;%= content %&gt;&lt;/body&gt;
&lt;/html&gt;
</code></pre>

</section>

</section>
<section>
      <section>
<h1>質問タイム</h1>

</section>

</section>
<section>
      <section>
<h1>お疲れさまでした</h1>

</section>

</section>

  </div>
</div>
<div style="position: absolute; top: 0; right: 0; z-index: 999;">
<a href="">TOP</a>
</div>
<script src="reveal/lib/js/head.min.js"></script>
<script src="reveal/js/reveal.min.js"></script>
<script>
  Reveal.initialize({
    controls: true,
    progress: true,
    history: true,
    keyboard: true,
    overview: true,
    center: true,
    loop: false,
    autoSlide: 0,
    mouseWheel: false,
    rollingLinks: true,
    theme: null,
    transition: 'default',
    dependencies: [
      { src: 'reveal/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal/plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
      { src: 'reveal/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'reveal/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
      { src: 'reveal/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
    ]
  });
</script>
<script src="app/app.js"></script>
</body>
</html>
